{% extends 'base/root.html' %}
{% load static %}
{% block extrastyle %}
  <style>
    .dataTables_filter {
      display: none;
    }

  </style>
{% endblock %}
{% block body %}
  {#################  PORTADA  ################}
  <section class="buscador-portada" style="background-image: url('{% static 'project/img/landing.png' %}'); background-size: 100% 100%;height: 500px;" id="">
    <div class="container h-100">
      <div style=" padding: 175px 0 " class="position-relative h-100">
        <div class="text-center">
          <h1 class="pb-4">{{ title }}</h1>
          <div class="pb-5">
            <p style="font-size: 18px;">{{ description }}</p>
          </div>
          <div>
            <div class="input-group" style="max-width: 60%; margin: auto">
              <input class="form-control" placeholder="{{ placeholder }}" id="query" value="{{ query }}"/>
              <div class="input-group-append">
              <span class="input-group-text" id="basic-addon2">
                <button tabindex="-1" class="btn btn-link text-danger {% if not query %}d-none{% endif %}" id="delete_search"> <i
                    class="fa fa-fw fa-times"></i></button>
                  <button tabindex="-1" class="btn btn-link" id="search"> <i
                      class="fa fa-fw fa-search"></i></button>
                </span>
              </div>
            </div>
          </div>

          {#        <button class="btn btn-warning text-white" style="padding: 2px 50px;">Estadísticas <br> Generales</button>#}
        </div>
      </div>

    </div>
  </section>
  <section id="resultados-section">
    <div class="container" style="padding: 50px 0">
      <p style="font-size: 32px; font-weight: 300; padding-bottom: 20px">Resultado de búsqueda</p>
      <p style="padding-bottom: 20px">Puedes ordenar los resultados de manera ascendente o descendente:</p>
      <div class="row w-100" style="background-color: white">
        <div class="table-responsive">
          <table id="data" class="table order-column stripe hover">
          </table>
        </div>
      </div>
    </div>
  </section>
{% endblock %}
{% block extrajs %}
  <script>
    $(() => {
      let searched_value = '{{ query|default:'' }}';

      let table = $('#data').DataTable({
          mark: {
            separateWordSearch: false,
          },
          buttons: [{
            extend: 'excel',
            text: '<i class="fa fa-file-excel me-1"></i> Exportar a Excel',
            filename: function () {
              return `*_proveedores_(${searched_value})`
            },
          }],
          oSearch: {sSearch: searched_value},
          serverSide: true,
          ajax: '{% url 'api_perfil-list' %}?format=datatables',
          columns: [
            {data: "link", className: "d-none disallow-mark",},
            {
              data: "ruc", title: 'RUC', className: "align-middle", render: function (data, type, row) {
                if (type === 'display') {
                  return `<a target="_blank" href="${row.link}">${data}</a>`;
                } else {
                  return data
                }
              }
            },
            {data: "razon_social", title: 'Razón Social', className: "align-middle"},
            {data: "tipoempresa", title: 'Tipo de Empresa', className: "align-middle"},
            {data: "organos_nomb_apell", title: 'Administrativos', className: "align-middle"},
            {data: "organos_nrodocumento", title: 'Administrativos', className: "align-middle d-none"},
            {data: "representantes_nomb_apell", title: 'Representantes', className: "align-middle"},
            {data: "representantes_nrodocumento", title: 'Representantes', className: "align-middle d-none"},
            {data: "socios", title: 'Socios', className: "align-middle"},
            {data: "socios_dni", title: 'Socios', className: "align-middle d-none"},
            {data: "seace_registros", title: '# Contratos', className: "align-middle dt-body-right disallow-mark"},
            {
              data: "seace_gasto_total", title: 'Monto Total', className: "align-middle dt-body-right dt-body-nowrap disallow-mark", render: function (data, type) {
                if (type === 'display') {
                  return (data) ? 'S/. ' + data : '--';
                } else {
                  return data
                }
              }
            },
            {data: "seace_fecha_min", title: 'Fecha Min', className: "align-middle dt-body-right dt-body-nowrap disallow-mark"},
            {data: "seace_fecha_max", title: 'Fecha Max', className: "align-middle dt-body-right dt-body-nowrap disallow-mark"},
          ],
          columnDefs: [
            {
              targets: [1, 2, 3],
              render: function (data, type) {
                if (type === 'display') {
                  return (data) ? data : '--';
                } else {
                  return data
                }
              },
            },
            {
              targets: [4, 5, 6, 7, 8, 9],
              render: function (data, type) {
                if (type === 'display') {
                  return (data) ? `${data.split('_._').map((n) => `<li>${n}</li>`).join('')}` : '--';
                } else {
                  return data
                }
              },
            },
            {
              targets: [-1, -2],
              render: function (data, type) {
                if (data) {
                  let date = moment(data, "YYYY-MM-DD");
                  return (type === 'display') ? date.format("DD/MM/YYYY") : date.format("X");
                } else {
                  return (type === 'display') ? '--' : data;
                }
              },
            },
            {
              searchable: false,
              "targets": [0, 3, -4, -3, -2, -1]
            },
            {
              orderable: false,
              "targets": [0]
            }
          ],
          order: [1, 'asc'],
        }
      );


      let $input = $('#query')

      function buscar() {
        let value = $input.val().trim()
        $input.val(value)
        const url = new URL(window.location.href);
        url.searchParams.set('q', value);
        window.history.replaceState(null, null, url);
        table.search(value).draw();
        searched_value = value
        $("html, body").animate({scrollTop: $('#resultados-section').offset().top - 100});
      }

      $('#search').on('click', buscar)
      $('#delete_search').on('click', function () {
        if ($input.val() !== '') {
          $input.val('')
          buscar()
          $('#delete_search').addClass('d-none')
        }
      })
      $input.on('keyup', e => {
        if (e.which === 13) buscar()
        $('#delete_search').toggleClass('d-none', ($input.val() === ''))
      })
    })
  </script>
{% endblock %}